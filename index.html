<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Manipulador de Webcam - Filtros em Tempo Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --dark-bg: #1e1b4b;
            --card-bg: #2d2a5a;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #312e81 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            padding: 20px 0;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .video-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        #videoElement {
            display: none;
        }

        #canvas {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .controls-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .filter-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .filter-btn.active {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: #e0e7ff;
        }

        .range-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            cursor: pointer;
            border: none;
        }

        .value-display {
            display: inline-block;
            background: rgba(99, 102, 241, 0.3);
            padding: 5px 15px;
            border-radius: 8px;
            font-weight: 600;
            color: #c7d2fe;
        }

        .d-flex.gap-2 {
            gap: 8px !important;
        }

        .btn-primary-custom,
        .btn-danger-custom {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .badge-custom {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 0;
            }

            .header {
                padding: 15px;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header .lead {
                font-size: 0.9rem;
            }
            
            .controls-panel {
                margin-top: 20px;
            }

            .video-container {
                padding: 15px;
            }

            #canvas {
                border-radius: 10px;
            }

            .filter-btn {
                padding: 12px;
                font-size: 0.9rem;
            }

            .control-group {
                padding: 15px;
                margin-bottom: 15px;
            }

            .control-group h5 {
                font-size: 1rem;
            }

            .stats-panel {
                padding: 12px;
            }

            .stat-item {
                font-size: 0.9rem;
            }

            .d-flex.gap-2 {
                flex-wrap: wrap;
            }

            .d-flex.gap-2 button {
                font-size: 0.85rem;
                padding: 10px 15px;
            }

            .badge-custom {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 576px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .video-container,
            .controls-panel {
                padding: 12px;
            }

            .filter-btn {
                padding: 10px;
                font-size: 0.85rem;
                margin-bottom: 8px;
            }

            .control-group {
                padding: 12px;
                margin-bottom: 12px;
            }

            .control-group label {
                font-size: 0.9rem;
            }

            .value-display {
                padding: 4px 10px;
                font-size: 0.85rem;
            }

            .btn-primary-custom,
            .btn-danger-custom {
                padding: 10px 20px;
                font-size: 0.85rem;
            }

            .stats-panel {
                padding: 10px;
                margin-top: 15px;
            }

            .stat-item {
                font-size: 0.85rem;
                padding: 6px 0;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .filter-btn,
            .btn-primary-custom,
            .btn-danger-custom {
                min-height: 44px;
                touch-action: manipulation;
            }

            .range-slider {
                height: 12px;
            }

            .range-slider::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }

            .range-slider::-moz-range-thumb {
                width: 28px;
                height: 28px;
            }
        }

        /* Orientação landscape em mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 10px;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.3rem;
                margin-bottom: 5px;
            }

            .header p {
                display: none;
            }

            .video-container {
                padding: 10px;
            }

            .stats-panel {
                display: flex;
                justify-content: space-around;
                margin-top: 10px;
            }

            .stat-item {
                border-bottom: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                padding: 5px 10px;
            }

            .stat-item:last-child {
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <div class="header">
            <h1><i class="bi bi-camera-video-fill"></i> Manipulador de Webcam</h1>
            <p class="lead mb-0">Filtros e Processamento de Imagem em Tempo Real</p>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="video-container">
                    <video id="videoElement" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    
                    <div class="d-flex gap-2 mt-3 flex-wrap">
                        <button id="startBtn" class="btn btn-primary-custom flex-fill">
                            <i class="bi bi-play-fill"></i> Iniciar Câmera
                        </button>
                        <button id="stopBtn" class="btn btn-danger-custom flex-fill" disabled>
                            <i class="bi bi-stop-fill"></i> Parar Câmera
                        </button>
                        <button id="switchCameraBtn" class="btn btn-primary-custom flex-fill d-none" disabled>
                            <i class="bi bi-arrow-repeat"></i> <span class="d-none d-sm-inline">Alternar</span>
                        </button>
                        <button id="captureBtn" class="btn btn-primary-custom flex-fill" disabled>
                            <i class="bi bi-camera-fill"></i> <span class="d-none d-sm-inline">Capturar</span>
                        </button>
                    </div>

                    <div class="stats-panel">
                        <div class="stat-item">
                            <span><i class="bi bi-speedometer2"></i> FPS:</span>
                            <span class="badge-custom" id="fpsDisplay">0</span>
                        </div>
                        <div class="stat-item">
                            <span><i class="bi bi-aspect-ratio"></i> Resolução:</span>
                            <span class="badge-custom" id="resolutionDisplay">-</span>
                        </div>
                        <div class="stat-item">
                            <span><i class="bi bi-filter"></i> Filtro Ativo:</span>
                            <span class="badge-custom" id="filterDisplay">Nenhum</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="controls-panel">
                    <h4 class="mb-4"><i class="bi bi-sliders"></i> Controles de Filtros</h4>
                    
                    <div class="control-group">
                        <h5>Filtros Básicos</h5>
                        <button class="filter-btn" data-filter="none">
                            <i class="bi bi-x-circle"></i> Sem Filtro
                        </button>
                        <button class="filter-btn" data-filter="grayscale">
                            <i class="bi bi-circle-half"></i> Preto e Branco
                        </button>
                        <button class="filter-btn" data-filter="invert">
                            <i class="bi bi-arrow-left-right"></i> Inverter Cores
                        </button>
                        <button class="filter-btn" data-filter="sepia">
                            <i class="bi bi-brightness-high"></i> Sépia
                        </button>
                    </div>

                    <div class="control-group">
                        <h5>Filtros Avançados</h5>
                        <button class="filter-btn" data-filter="edge">
                            <i class="bi bi-grid-3x3"></i> Detecção de Bordas
                        </button>
                        <button class="filter-btn" data-filter="blur">
                            <i class="bi bi-droplet"></i> Desfoque
                        </button>
                        <button class="filter-btn" data-filter="brightness">
                            <i class="bi bi-lightbulb"></i> Pontos Luminosos
                        </button>
                        <button class="filter-btn" data-filter="pixelate">
                            <i class="bi bi-grid"></i> Pixelizar
                        </button>
                    </div>

                    <div class="control-group">
                        <label>
                            <i class="bi bi-brightness-alt-high"></i> 
                            Intensidade: 
                            <span class="value-display" id="intensityValue">100</span>%
                        </label>
                        <input type="range" class="range-slider" id="intensitySlider" 
                               min="0" max="200" value="100">
                    </div>

                    <div class="control-group">
                        <label>
                            <i class="bi bi-sun"></i> 
                            Limiar de Brilho: 
                            <span class="value-display" id="thresholdValue">200</span>
                        </label>
                        <input type="range" class="range-slider" id="thresholdSlider" 
                               min="0" max="255" value="200">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class WebcamFilter {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.stream = null;
                this.animationId = null;
                this.currentFilter = 'none';
                this.intensity = 100;
                this.threshold = 200;
                this.fps = 0;
                this.lastFrameTime = Date.now();
                this.frameCount = 0;
                this.facingMode = 'environment'; // Padrão: câmera traseira
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                this.initializeElements();
                this.attachEventListeners();
                
                // Mostrar botão de alternar câmera apenas em mobile
                if (this.isMobile) {
                    this.switchCameraBtn.classList.remove('d-none');
                }
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.switchCameraBtn = document.getElementById('switchCameraBtn');
                this.filterBtns = document.querySelectorAll('.filter-btn');
                this.intensitySlider = document.getElementById('intensitySlider');
                this.thresholdSlider = document.getElementById('thresholdSlider');
                this.fpsDisplay = document.getElementById('fpsDisplay');
                this.resolutionDisplay = document.getElementById('resolutionDisplay');
                this.filterDisplay = document.getElementById('filterDisplay');
                this.intensityValue = document.getElementById('intensityValue');
                this.thresholdValue = document.getElementById('thresholdValue');
            }

            attachEventListeners() {
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
                this.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.switchCameraBtn.addEventListener('click', () => this.switchCamera());
                
                this.filterBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.filterBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentFilter = btn.dataset.filter;
                        this.filterDisplay.textContent = btn.textContent.trim();
                    });
                });

                this.intensitySlider.addEventListener('input', (e) => {
                    this.intensity = e.target.value;
                    this.intensityValue.textContent = e.target.value;
                });

                this.thresholdSlider.addEventListener('input', (e) => {
                    this.threshold = e.target.value;
                    this.thresholdValue.textContent = e.target.value;
                });
            }

            async startCamera() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: this.isMobile ? 1920 : 1280 },
                            height: { ideal: this.isMobile ? 1080 : 720 },
                            facingMode: this.isMobile ? this.facingMode : 'user'
                        }
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);

                    this.video.srcObject = this.stream;
                    
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.resolutionDisplay.textContent = 
                            `${this.video.videoWidth}x${this.video.videoHeight}`;
                        this.processFrame();
                    });

                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.captureBtn.disabled = false;
                    if (this.isMobile) {
                        this.switchCameraBtn.disabled = false;
                    }
                    
                } catch (error) {
                    alert('Erro ao acessar a câmera: ' + error.message);
                }
            }

            async switchCamera() {
                // Alternar entre câmeras frontal e traseira
                this.facingMode = this.facingMode === 'user' ? 'environment' : 'user';
                
                // Parar a câmera atual
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    cancelAnimationFrame(this.animationId);
                }

                // Reiniciar com a nova câmera
                await this.startCamera();
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    cancelAnimationFrame(this.animationId);
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.captureBtn.disabled = true;
                    this.switchCameraBtn.disabled = true;
                    this.fpsDisplay.textContent = '0';
                }
            }

            processFrame() {
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                
                if (this.currentFilter !== 'none') {
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    const filteredData = this.applyFilter(imageData);
                    this.ctx.putImageData(filteredData, 0, 0);
                }

                this.calculateFPS();
                this.animationId = requestAnimationFrame(() => this.processFrame());
            }

            applyFilter(imageData) {
                const data = imageData.data;
                const factor = this.intensity / 100;

                switch (this.currentFilter) {
                    case 'grayscale':
                        return this.grayscaleFilter(data, factor);
                    case 'invert':
                        return this.invertFilter(data, factor);
                    case 'sepia':
                        return this.sepiaFilter(data, factor);
                    case 'edge':
                        return this.edgeDetection(imageData);
                    case 'blur':
                        return this.blurFilter(imageData);
                    case 'brightness':
                        return this.brightnessDetection(data);
                    case 'pixelate':
                        return this.pixelateFilter(imageData);
                }

                return imageData;
            }

            grayscaleFilter(data, factor) {
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i] = data[i] + (avg - data[i]) * factor;
                    data[i + 1] = data[i + 1] + (avg - data[i + 1]) * factor;
                    data[i + 2] = data[i + 2] + (avg - data[i + 2]) * factor;
                }
                return new ImageData(data, this.canvas.width, this.canvas.height);
            }

            invertFilter(data, factor) {
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = data[i] + (255 - data[i] - data[i]) * factor;
                    data[i + 1] = data[i + 1] + (255 - data[i + 1] - data[i + 1]) * factor;
                    data[i + 2] = data[i + 2] + (255 - data[i + 2] - data[i + 2]) * factor;
                }
                return new ImageData(data, this.canvas.width, this.canvas.height);
            }

            sepiaFilter(data, factor) {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    data[i] = Math.min(255, (r * 0.393 + g * 0.769 + b * 0.189) * factor);
                    data[i + 1] = Math.min(255, (r * 0.349 + g * 0.686 + b * 0.168) * factor);
                    data[i + 2] = Math.min(255, (r * 0.272 + g * 0.534 + b * 0.131) * factor);
                }
                return new ImageData(data, this.canvas.width, this.canvas.height);
            }

            edgeDetection(imageData) {
                const src = imageData.data;
                const dst = new Uint8ClampedArray(src);
                const w = this.canvas.width;
                const h = this.canvas.height;

                const sobelX = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]];
                const sobelY = [[-1, -2, -1], [0, 0, 0], [1, 2, 1]];

                for (let y = 1; y < h - 1; y++) {
                    for (let x = 1; x < w - 1; x++) {
                        let pixelX = 0;
                        let pixelY = 0;

                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * w + (x + kx)) * 4;
                                const gray = (src[idx] + src[idx + 1] + src[idx + 2]) / 3;
                                pixelX += gray * sobelX[ky + 1][kx + 1];
                                pixelY += gray * sobelY[ky + 1][kx + 1];
                            }
                        }

                        const magnitude = Math.sqrt(pixelX * pixelX + pixelY * pixelY);
                        const idx = (y * w + x) * 4;
                        dst[idx] = dst[idx + 1] = dst[idx + 2] = magnitude;
                    }
                }

                return new ImageData(dst, w, h);
            }

            blurFilter(imageData) {
                const src = imageData.data;
                const dst = new Uint8ClampedArray(src);
                const w = this.canvas.width;
                const h = this.canvas.height;
                const radius = Math.floor(this.intensity / 20);

                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        let r = 0, g = 0, b = 0, count = 0;

                        for (let ky = -radius; ky <= radius; ky++) {
                            for (let kx = -radius; kx <= radius; kx++) {
                                const nx = x + kx;
                                const ny = y + ky;
                                
                                if (nx >= 0 && nx < w && ny >= 0 && ny < h) {
                                    const idx = (ny * w + nx) * 4;
                                    r += src[idx];
                                    g += src[idx + 1];
                                    b += src[idx + 2];
                                    count++;
                                }
                            }
                        }

                        const idx = (y * w + x) * 4;
                        dst[idx] = r / count;
                        dst[idx + 1] = g / count;
                        dst[idx + 2] = b / count;
                    }
                }

                return new ImageData(dst, w, h);
            }

            brightnessDetection(data) {
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    
                    if (brightness > this.threshold) {
                        data[i] = 255;
                        data[i + 1] = 255;
                        data[i + 2] = 0;
                    } else {
                        data[i] = data[i + 1] = data[i + 2] = 0;
                    }
                }
                return new ImageData(data, this.canvas.width, this.canvas.height);
            }

            pixelateFilter(imageData) {
                const size = Math.max(1, Math.floor(this.intensity / 10));
                const w = this.canvas.width;
                const h = this.canvas.height;
                const data = imageData.data;

                for (let y = 0; y < h; y += size) {
                    for (let x = 0; x < w; x += size) {
                        const idx = (y * w + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];

                        for (let dy = 0; dy < size && y + dy < h; dy++) {
                            for (let dx = 0; dx < size && x + dx < w; dx++) {
                                const i = ((y + dy) * w + (x + dx)) * 4;
                                data[i] = r;
                                data[i + 1] = g;
                                data[i + 2] = b;
                            }
                        }
                    }
                }

                return new ImageData(data, w, h);
            }

            calculateFPS() {
                this.frameCount++;
                const now = Date.now();
                const elapsed = now - this.lastFrameTime;

                if (elapsed >= 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / elapsed);
                    this.fpsDisplay.textContent = this.fps;
                    this.frameCount = 0;
                    this.lastFrameTime = now;
                }
            }

            capturePhoto() {
                const link = document.createElement('a');
                link.download = `webcam-capture-${Date.now()}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
            }
        }

        // Inicializar aplicação
        const app = new WebcamFilter();
    </script>
</body>
</html>
